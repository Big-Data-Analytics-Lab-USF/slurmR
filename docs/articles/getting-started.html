<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started with sluRm • sluRm</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with sluRm">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sluRm</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting-started.html">Getting Started with sluRm</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Getting Started with sluRm</h1>
                        <h4 class="author">George G. Vega Yon</h4>
            
            <h4 class="date">2018-10-31</h4>
      
      
      <div class="hidden name"><code>getting-started.Rmd</code></div>

    </div>

    
    
<div id="introduccion" class="section level1">
<h1 class="hasAnchor">
<a href="#introduccion" class="anchor"></a>Introduccion</h1>
<p><a href="">Slurm Work Manager</a> (formerly <em>Simple Linux Utility for Resource Manager</em>),</p>
<p>Some important definitions</p>
<ol style="list-style-type: decimal">
<li>
<strong>Node</strong> A single computer in the HPC.</li>
<li>
<strong>Partition</strong> A group of nodes in HPC (see <code>--partition</code>).</li>
<li>
<strong>Account</strong> Accounts associated with partitions. Accounts can have privileges to use a partition or set of nodes. (see <code>--account</code>)</li>
<li>
<strong>Job</strong> A job submited to slurm either via <code>sbatch</code>, <code>salloc</code>, or <code>srun</code>.</li>
<li>
<strong>Task</strong> A step within a job. A particular job can have multiple tasks.</li>
<li>
<strong>CPU</strong> (see <code>--cpus-per-task</code>, <code>--</code>)</li>
</ol>
<p><a href="https://slurm.schedmd.com/cpu_management.html">https://slurm.schedmd.com/cpu_management.html</a></p>
<table style="page-break-inside: avoid; font-family: Arial,Helvetica,sans-serif;" border="1" bordercolor="#000000" cellpadding="3" cellspacing="0" width="591" class="table">
<colgroup>
<col width="210">
<col width="16">
<col width="16">
<col width="16">
<col width="16">
<col width="16">
<col width="16">
<col width="16">
<col width="16">
<col width="16">
<col width="16">
<col width="20">
<col width="20">
<col width="20">
<col width="20">
<col width="20">
<col width="19">
</colgroup>
<tbody>
<tr>
<td bgcolor="#e0e0e0" width="210">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>Nodename</b></font>
</p>
            </td>
            <td colspan="16" bgcolor="#e0e0e0" width="367">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>n3</b></font>
</p>
            </td>
        </tr>
<tr>
<td bgcolor="#e0e0e0" width="210">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>Socket id</b></font>
</p>
            </td>
            <td colspan="8" bgcolor="#e0e0e0" width="170">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>0</b></font>
</p>
            </td>
            <td colspan="8" bgcolor="#e0e0e0" width="191">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>1</b></font>
</p>
            </td>
        </tr>
<tr>
<td bgcolor="#e0e0e0" width="210">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>Core id</b></font>
</p>
            </td>
            <td colspan="2" bgcolor="#e0e0e0" width="38">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>0</b></font>
</p>
            </td>
            <td colspan="2" bgcolor="#e0e0e0" width="38">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>1</b></font>
</p>
            </td>
            <td colspan="2" bgcolor="#e0e0e0" width="38">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>2</b></font>
</p>
            </td>
            <td colspan="2" bgcolor="#e0e0e0" width="38">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>3</b></font>
</p>
            </td>
            <td colspan="2" bgcolor="#e0e0e0" width="38">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>0</b></font>
</p>
            </td>
            <td colspan="2" bgcolor="#e0e0e0" width="45">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>1</b></font>
</p>
            </td>
            <td colspan="2" bgcolor="#e0e0e0" width="45">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>2</b></font>
</p>
            </td>
            <td colspan="2" bgcolor="#e0e0e0" width="44">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>3</b></font>
</p>
            </td>
        </tr>
<tr>
<td bgcolor="#e0e0e0" width="210">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>CPU id</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>0</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>1</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>2</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>3</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>4</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>5</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>6</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>7</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>8</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="16">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>9</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="20">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>10</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="20">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>11</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="20">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>12</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="20">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>13</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="20">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>14</b></font>
</p>
            </td>
            <td bgcolor="#e0e0e0" width="19">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>15</b></font>
</p>
            </td>
        </tr>
<tr>
<td bgcolor="#e0e0e0" width="210">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>Number of Allocated CPUs</b></font>
</p>
            </td>
            <td colspan="8" width="170">
                <p align="CENTER">
<font style="font-size: 8pt" size="1">4</font>
</p>
            </td>
            <td colspan="8" width="191">
                <p align="CENTER">
<font style="font-size: 8pt" size="1">4</font>
</p>
            </td>
        </tr>
<tr>
<td bgcolor="#e0e0e0" width="210">
                <p align="CENTER">
<font style="font-size: 8pt" size="1"><b>Allocated CPU ids</b></font>
</p>
            </td>
            <td colspan="8" width="170">
                <p align="CENTER">
<font style="font-size: 8pt" size="1">0 2 4 6</font>
</p>
            </td>
            <td colspan="8" width="191">
                <p align="CENTER">
<font style="font-size: 8pt" size="1">8 10 12 14</font>
</p>
            </td>
        </tr>
</tbody>
</table>
<blockquote>
<p>Unless overcommitment of CPUs to tasks is specified for the job, the number of tasks distributed to a node is constrained by the number of CPUs allocated on the node and the number of CPUs per task – <a href="https://slurm.schedmd.com/cpu_management.html">Slurm CPU Management</a></p>
</blockquote>
</div>
<div id="implementation-of-the-slurrm-package" class="section level1">
<h1 class="hasAnchor">
<a href="#implementation-of-the-slurrm-package" class="anchor"></a>Implementation of the <code>sluRrm</code> package</h1>
<p>Just like <code>rslurm</code>, <code>sluRm</code> has two levels of job distribution: Slurm Jobs (via the <code>Slurm_lapply</code> function), and within each job via <code><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">parallel::mclapply</a></code> (task forking).</p>
<p>In general, the function <code>Slurm_lapply</code> is implemented as follows:</p>
<ol style="list-style-type: decimal">
<li><p>List whatever R packages are loaded, including the path to the R package.</p></li>
<li><p>List all the objects passed via elipsis (<code>...</code>), and, together with <code>X</code> and <code>FUN</code>, save them at <code>[job_path]/[job_name]/</code> as <code>[object-name].rds</code>.</p></li>
<li><p>Write out the corresponding R script and Slurm bash file, and save them as <code>[job_path]/[job_name]/00-rscript.r</code>, and <code>[job_path]/[job_name]/01-bash.sh</code> respectively.</p></li>
<li><p>If <code>submit = TRUE</code> (the default), the job will be submitted to the queue, which implies that <code>Slurm_lapply</code> will call <code><a href="../reference/sbatch.html">sbatch()</a></code>. Then return.</p></li>
<li><p>Once <code><a href="../reference/sbatch.html">sbatch()</a></code> is called, a Job Array will be submitted in which each R job will lunch up to <code>mc.cores</code> forked processes (2nd layer of parallelization)</p></li>
</ol>
<p>Users can collect their results using the function <code>Slurm_collect</code>.</p>
</div>
<div id="examples" class="section level1">
<h1 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h1>
<div id="simulating-pi" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-pi" class="anchor"></a>Simulating Pi</h2>
<p>We would like to implement a simulation algorithm to be run in a cluster. In this case, we have the very simple function we would like to parallelize:</p>
<pre class="sourceCode r"><code class="sourceCode r">simpi &lt;-<span class="st"> </span>function(n) {
  points &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(n*<span class="dv">2</span>), <span class="dt">ncol=</span><span class="dv">2</span>)
  <span class="kw">mean</span>(<span class="kw">rowSums</span>(points^<span class="dv">2</span>) &lt;=<span class="st"> </span><span class="dv">1</span>)*<span class="dv">4</span>
}</code></pre>
<p>This simple function generates Pi. Using <code><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">parallel::mclapply</a></code>, we could just type</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">12</span>)
ans &lt;-<span class="st"> </span>parallel::<span class="kw">mclapply</span>(<span class="kw">rep</span>(<span class="fl">1e6</span>, <span class="dv">100</span>), simpi)
<span class="kw">mean</span>(<span class="kw">unlist</span>(ans))</code></pre>
<p>But there’s another way, using <code>Slurm_lapply</code>, we can write</p>
<pre class="sourceCode r"><code class="sourceCode r">job &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Slurm_lapply.html">Slurm_lapply</a></span>(<span class="kw">rep</span>(<span class="fl">1e6</span>, <span class="dv">100</span>), simpi, <span class="dt">njobs=</span><span class="dv">10</span>, <span class="dt">mc.cores=</span><span class="dv">10</span>, <span class="dt">wait =</span> <span class="ot">TRUE</span>)
ans &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Slurm_collect.html">Slurm_collect</a></span>(job)
<span class="kw">mean</span>(<span class="kw">unlist</span>(ans))</code></pre>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#!/bin/bash</span>
<span class="co">#SBATCH</span>
<span class="kw">Rscript</span> --vanilla myjob.R</code></pre>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw"><a href="../reference/sbatch.html">sbatch</a></span> run_jobs.sh</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sluRm)
<span class="kw">library</span>(parallel) <span class="co"># Example library you would like to load</span>

dat &lt;-<span class="st"> </span><span class="kw">sample.int</span>(<span class="dv">1000</span>, <span class="dv">10</span>, <span class="ot">TRUE</span>)
job &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Slurm_lapply.html">Slurm_lapply</a></span>(dat, mean, <span class="dt">wait =</span> <span class="ot">TRUE</span>)

ans &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Slurm_collect.html">Slurm_collect</a></span>(job)
ans</code></pre>
</div>
</div>
<div id="common-options-to-pass-via-sbatch_opt" class="section level1">
<h1 class="hasAnchor">
<a href="#common-options-to-pass-via-sbatch_opt" class="anchor"></a>Common options to pass via <code>sbatch_opt</code>
</h1>
<p>Options to <code>sbatch</code> can be passed via <code>sbatch_opt</code> as a list. For example, the following</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list</span>(
  <span class="st">`</span><span class="dt">job-name</span><span class="st">`</span>    =<span class="st"> "my-fancy-slurm-job"</span>,
  <span class="st">`</span><span class="dt">mem-per-cpu</span><span class="st">`</span> =<span class="st"> "4G"</span>,
  <span class="dt">time          =</span> <span class="st">"12:00:00"</span>,
  <span class="dt">ntasks        =</span> <span class="dv">10</span>
)</code></pre>
<p>Advices Slurm to allocate 4G of memory per task, set a maximum time limit of 12 hours, and specify that you will be running 10 tasks per job.</p>
<p>A comprehensive list of options can be found <a href="https://slurm.schedmd.com/sbatch.html">here</a>.</p>
</div>
<div id="appendix" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h1>
<p>Extract from the FAQs at the Slurm website:</p>
<blockquote>
<p><strong>30. Slurm documentation refers to CPUs, cores and threads. What exactly is considered a CPU?</strong> If your nodes are configured with hyperthreading, then a CPU is equivalent to a hyperthread. Otherwise a CPU is equivalent to a core. You can determine if your nodes have more than one thread per core using the command “scontrol show node” and looking at the values of “ThreadsPerCore”.</p>
<p><em>Note that even on systems with hyperthreading enabled, the resources will generally be allocated to jobs at the level of a core</em> (see NOTE below). Two different jobs will not share a core except through the use of a partition OverSubscribe configuration parameter. For example, a job requesting resources for three tasks on a node with ThreadsPerCore=2 will be allocated two full cores. Note that Slurm commands contain a multitude of options to control resource allocation with respect to base boards, sockets, cores and threads. — <a href="https://slurm.schedmd.com/faq.html#cpu_count">FAQ #30</a></p>
</blockquote>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduccion">Introduccion</a></li>
      <li><a href="#implementation-of-the-slurrm-package">Implementation of the <code>sluRrm</code> package</a></li>
      <li>
<a href="#examples">Examples</a><ul class="nav nav-pills nav-stacked">
<li><a href="#simulating-pi">Simulating Pi</a></li>
      </ul>
</li>
      <li><a href="#common-options-to-pass-via-sbatch_opt">Common options to pass via <code>sbatch_opt</code></a></li>
      <li><a href="#appendix">Appendix</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by George Vega Yon.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
