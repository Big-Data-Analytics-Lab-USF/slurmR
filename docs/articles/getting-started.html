<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started with sluRm • sluRm</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with sluRm">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sluRm</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting-started.html">Getting Started with sluRm</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Getting Started with sluRm</h1>
                        <h4 class="author">George G. Vega Yon</h4>
            
            <h4 class="date">2019-02-13</h4>
      
      
      <div class="hidden name"><code>getting-started.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p><a href="https://slurm.schedmd.com/">Slurm Work Manager</a> (formerly <em>Simple Linux Utility for Resource Manager</em>),</p>
<p>Some important definitions</p>
<ol style="list-style-type: decimal">
<li>
<strong>Node</strong> A single computer in the HPC.</li>
<li>
<strong>Partition</strong> A group of nodes in HPC (see <code>--partition</code>).</li>
<li>
<strong>Account</strong> Accounts associated with partitions. Accounts can have privileges to use a partition or set of nodes. (see <code>--account</code>)</li>
<li>
<strong>Job</strong> A job submited to slurm either via <code>sbatch</code>, <code>salloc</code>, or <code>srun</code>.</li>
<li>
<strong>Task</strong> A step within a job. A particular job can have multiple tasks.</li>
<li>
<strong>CPU</strong> (see <code>--cpus-per-task</code>, <code>--</code>)</li>
</ol>
<p><a href="https://slurm.schedmd.com/cpu_management.html" class="uri">https://slurm.schedmd.com/cpu_management.html</a></p>
<blockquote>
<p>Unless overcommitment of CPUs to tasks is specified for the job, the number of tasks distributed to a node is constrained by the number of CPUs allocated on the node and the number of CPUs per task – <a href="https://slurm.schedmd.com/cpu_management.html">Slurm CPU Management</a></p>
</blockquote>
</div>
<div id="implementation-of-the-slurrm-package" class="section level1">
<h1 class="hasAnchor">
<a href="#implementation-of-the-slurrm-package" class="anchor"></a>Implementation of the <code>sluRrm</code> package</h1>
<p>Just like <code>rslurm</code>, <code>sluRm</code> has two levels of job distribution: Slurm Jobs (via the <code>Slurm_lapply</code> and <code>Slurm_Map</code> functions), and within each job via <code><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">parallel::mclapply</a></code> and <code><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">parallel::mcMap</a></code> (task forking).</p>
<p>In general, the function <code>Slurm_*</code> is implemented as follows:</p>
<ol style="list-style-type: decimal">
<li><p>List whatever R packages are loaded, including the path to the R package.</p></li>
<li><p>List all the objects passed via elipsis (<code>...</code>), and, together with <code>X</code> and <code>FUN</code> or <code>f</code>, save them at <code>[job_path]/[job_name]/</code> as <code>[object-name].rds</code>.</p></li>
<li><p>Write out the corresponding R script and Slurm bash file, and save them as <code>[job_path]/[job_name]/00-rscript.r</code>, and <code>[job_path]/[job_name]/01-bash.sh</code> respectively.</p></li>
<li><p>If <code>submit = TRUE</code> (the default), the job will be submitted to the queue, which implies that <code>Slurm_lapply</code> will call <code><a href="../reference/sbatch.html">sbatch()</a></code>. Then return.</p></li>
<li><p>Once <code><a href="../reference/sbatch.html">sbatch()</a></code> is called, a Job Array will be submitted in which each R job will lunch up to <code>mc.cores</code> forked processes (2nd layer of parallelization)</p></li>
</ol>
<p>Users can collect their results using the function <code>Slurm_collect</code>.</p>
</div>
<div id="examples" class="section level1">
<h1 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h1>
<div id="simulating-pi" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-pi" class="anchor"></a>Simulating Pi</h2>
<p>We would like to implement a simulation algorithm to be run in a cluster. In this case, we have the very simple function we would like to parallelize:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">simpi &lt;-<span class="st"> </span><span class="cf">function</span>(n) {</a>
<a class="sourceLine" id="cb1-2" title="2">  points &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(n<span class="op">*</span><span class="dv">2</span>), <span class="dt">ncol=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="kw">mean</span>(<span class="kw">rowSums</span>(points<span class="op">^</span><span class="dv">2</span>) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1</span>)<span class="op">*</span><span class="dv">4</span></a>
<a class="sourceLine" id="cb1-4" title="4">}</a></code></pre></div>
<p>This simple function generates Pi. Using <code><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">parallel::mclapply</a></code>, we could just type</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">set.seed</span>(<span class="dv">12</span>)</a>
<a class="sourceLine" id="cb2-2" title="2">ans &lt;-<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(<span class="kw">rep</span>(<span class="fl">1e6</span>, <span class="dv">100</span>), simpi)</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">mean</span>(<span class="kw">unlist</span>(ans))</a></code></pre></div>
<p>But there’s another way, using <code>Slurm_lapply</code>, we can write</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">library</span>(sluRm)</a></code></pre></div>
<pre><code>## On load, `sluRm` sets default options for your jobs (`chdir`, which is the default directory where sluRm will use to create the auxiliar files, and `job-name`, which is the option of the same name in Slurm. You can view/set these at:
##    ?opts_sluRm
## or you could just type
##    "opts_sluRm".</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># Setting required parameters</span></a>
<a class="sourceLine" id="cb5-2" title="2">opts_sluRm<span class="op">$</span><span class="kw">set_chdir</span>(<span class="kw">tempdir</span>())</a>
<a class="sourceLine" id="cb5-3" title="3">opts_sluRm<span class="op">$</span><span class="kw">set_job_name</span>(<span class="st">"test1"</span>)</a>
<a class="sourceLine" id="cb5-4" title="4"></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="co"># Optional parameters are set via set_opts</span></a>
<a class="sourceLine" id="cb5-6" title="6">opts_sluRm<span class="op">$</span><span class="kw">set_opts</span>(<span class="dt">partition=</span><span class="st">"conti"</span>, <span class="dt">account=</span><span class="st">"lc_dvc"</span>)</a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co"># We can look at the setup</span></a>
<a class="sourceLine" id="cb5-9" title="9">opts_sluRm</a></code></pre></div>
<pre><code>## Current default for Slurm jobs:
## 
## List of 4
##  $ partition: chr "conti"
##  $ chdir    : chr "/tmp/RtmpRR95h7"
##  $ account  : chr "lc_dvc"
##  $ job-name : chr "test1"
## 
## To get and set options for Slurm jobs creation use (see ?opts_sluRm):
## 
## debug_off : function ()  
## debug_on : function ()  
## get_chdir : function ()  
## get_cmd : function ()  
## get_debug : function ()  
## get_job_name : function (check = TRUE)  
## get_opts : function (...)  
## get_verbose : function ()  
## set_chdir : function (path, recursive = TRUE, overwrite = FALSE)  
## set_job_name : function (path, check = TRUE, overwrite = TRUE)  
## set_opts : function (...)  
## verbose_off : function ()  
## verbose_on : function ()</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">job &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Slurm_lapply.html">Slurm_lapply</a></span>(<span class="kw">rep</span>(<span class="fl">1e6</span>, <span class="dv">100</span>), simpi, <span class="dt">njobs=</span><span class="dv">10</span>, <span class="dt">mc.cores=</span><span class="dv">10</span>, <span class="dt">wait =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb7-2" title="2">ans &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Slurm_collect.html">Slurm_collect</a></span>(job)</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">mean</span>(<span class="kw">unlist</span>(ans))</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">#SBATCH</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="ex">Rscript</span> --vanilla myjob.R</a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1">$ <span class="ex">sbatch</span> run_jobs.sh</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">library</span>(sluRm)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">library</span>(parallel) <span class="co"># Example package you would like to load</span></a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4">dat &lt;-<span class="st"> </span><span class="kw">sample.int</span>(<span class="dv">1000</span>, <span class="dv">10</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-5" title="5">job &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Slurm_lapply.html">Slurm_lapply</a></span>(dat, mean, <span class="dt">wait =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7">ans &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Slurm_collect.html">Slurm_collect</a></span>(job)</a>
<a class="sourceLine" id="cb10-8" title="8">ans</a></code></pre></div>
</div>
</div>
<div id="common-options-to-pass-via-sbatch_opt" class="section level1">
<h1 class="hasAnchor">
<a href="#common-options-to-pass-via-sbatch_opt" class="anchor"></a>Common options to pass via <code>sbatch_opt</code>
</h1>
<p>Options to <code>sbatch</code> can be passed via <code>sbatch_opt</code> as a list. For example, the following</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="st">`</span><span class="dt">job-name</span><span class="st">`</span>    =<span class="st"> "my-fancy-slurm-job"</span>,</a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="st">`</span><span class="dt">mem-per-cpu</span><span class="st">`</span> =<span class="st"> "4G"</span>,</a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="dt">time          =</span> <span class="st">"12:00:00"</span>,</a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="dt">ntasks        =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb11-6" title="6">)</a></code></pre></div>
<p>Advices Slurm to allocate 4G of memory per task, set a maximum time limit of 12 hours, and specify that you will be running 10 tasks per job.</p>
<p>A comprehensive list of options can be found <a href="https://slurm.schedmd.com/sbatch.html">here</a>.</p>
</div>
<div id="appendix" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h1>
<p>Extract from the FAQs at the Slurm website:</p>
<blockquote>
<p><strong>30. Slurm documentation refers to CPUs, cores and threads. What exactly is considered a CPU?</strong> If your nodes are configured with hyperthreading, then a CPU is equivalent to a hyperthread. Otherwise a CPU is equivalent to a core. You can determine if your nodes have more than one thread per core using the command “scontrol show node” and looking at the values of “ThreadsPerCore”.</p>
<p><em>Note that even on systems with hyperthreading enabled, the resources will generally be allocated to jobs at the level of a core</em> (see NOTE below). Two different jobs will not share a core except through the use of a partition OverSubscribe configuration parameter. For example, a job requesting resources for three tasks on a node with ThreadsPerCore=2 will be allocated two full cores. Note that Slurm commands contain a multitude of options to control resource allocation with respect to base boards, sockets, cores and threads. — <a href="https://slurm.schedmd.com/faq.html#cpu_count">FAQ #30</a></p>
</blockquote>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#implementation-of-the-slurrm-package">Implementation of the <code>sluRrm</code> package</a></li>
      <li>
<a href="#examples">Examples</a><ul class="nav nav-pills nav-stacked">
<li><a href="#simulating-pi">Simulating Pi</a></li>
      </ul>
</li>
      <li><a href="#common-options-to-pass-via-sbatch_opt">Common options to pass via <code>sbatch_opt</code></a></li>
      <li><a href="#appendix">Appendix</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by George Vega Yon.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
